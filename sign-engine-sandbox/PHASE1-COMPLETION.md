# Sign Engine Phase 1 é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å°†å½“å‰ `web/engine.js` ä¸­çš„å¸ƒå±€é€»è¾‘è¿ç§»åˆ°æ ‡å‡†çš„ D1-D4 æ¶æ„ä¸­ï¼Œä½¿ `engine.js` ä»"è‡ªå®ç°å¸ƒå±€å¼•æ“"è½¬å˜ä¸º"å¸ƒå±€å¼•æ“é€‚é…å™¨"ã€‚åŒæ—¶å®ç° G1-1 å’Œ G1-2 ä¸¤ç§å †å å¼æŒ‡å—ç‰Œç±»å‹ã€‚

## âœ… å®Œæˆçš„ä»»åŠ¡

### Task 1: æ‰©å…… D1/primitives.js âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/d1/primitives.js`
- **æ–°å¢åŠŸèƒ½**: `stackBoards()` å‡½æ•°
- **åŠŸèƒ½**: å‚ç›´å †å å¤šä¸ª boardï¼Œæ”¯æŒç­‰å®½æ¨¡å¼å’Œè‡ªåŠ¨å±…ä¸­
- **å…³é”®å‚æ•°**:
  - `boards`: board æ•°ç»„
  - `spacing_h`: board ä¹‹é—´çš„é—´è·ï¼ˆh å•ä½ï¼‰
  - `equalWidth`: æ˜¯å¦ç»Ÿä¸€å®½åº¦

### Task 2: å¢å¼º D2/converter.js âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/d2/converter.js`
- **ä¿®æ”¹å†…å®¹**:
  1. `toBoxText()` - æ”¯æŒ `fontMetrics` åŠ¨æ€å‚æ•°è¦†ç›–
  2. `toBoxIcon()` - æ”¯æŒ shield å¸¦ labelï¼Œæ ¹æ®æ–‡å­—å®½åº¦åŠ¨æ€è°ƒæ•´
- **å­—æ®µçº§åˆå¹¶ç­–ç•¥**: ä¼ å…¥çš„ `fontMetrics` ä¼šè¦†ç›– JSON é»˜è®¤é…ç½®

### Task 3: å¢å¼º D3/layout-g11.js âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/d3/layout-g11.js`
- **æ–°å¢åŠŸèƒ½**:
  1. æ”¯æŒ shield å›¾æ ‡ï¼ˆæ”¾ç½®åœ¨å·¦ä¾§ï¼‰
  2. å®Œæ•´çš„ä¸‰å…ƒç´ å¸ƒå±€ï¼šshield - text - arrow
  3. ç»Ÿä¸€çš„å…ƒç´ æ’åˆ—é€»è¾‘
  4. æ”¹è¿›çš„è¾“å‡ºæ¨¡å‹æ„å»º
- **å‡½æ•°ç­¾åæ›´æ–°**: å¢åŠ  `fontMetrics` å’Œ `iconConfig` å‚æ•°

### Task 4: æ–°å»º D3/layout-g12.js âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/d3/layout-g12.js` (æ–°å»º)
- **åŠŸèƒ½**: å®ç° G1-2 ä¸‰å—é¢æ¿å‚ç›´å †å å¸ƒå±€
- **æ ¸å¿ƒé€»è¾‘**:
  1. `layoutSinglePanel()` - å¸ƒå±€å•ä¸ªé¢æ¿ï¼ˆå¤ç”¨ G1-1 é€»è¾‘ï¼‰
  2. `layoutG12()` - ä¸»å‡½æ•°ï¼Œè°ƒç”¨ 3 æ¬¡å•é¢æ¿å¸ƒå±€åç”¨ `stackBoards()` å †å 
  3. æ”¯æŒæ¯ä¸ªé¢æ¿ç‹¬ç«‹çš„ destinationã€distanceã€arrowã€shield
- **è¾“å…¥æ ¼å¼**: `input.panels` æ•°ç»„åŒ…å« 3 ä¸ªé¢æ¿æ•°æ®

### Task 5: æ›´æ–° D3/templates.json âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/d3/templates.json`
- **æ–°å¢**: G1-2 æ¨¡æ¿é…ç½®
- **å…³é”®å‚æ•°**:
  - `panel_spacing_h: 0.3` - é¢æ¿ä¹‹é—´çš„é—´è·
  - `variables: ["panels"]` - è¾“å…¥å˜é‡å®šä¹‰

### Task 6: é‡å†™ web/engine.js âœ“
- **æ–‡ä»¶**: `sign-engine-sandbox/web/engine.js`
- **é‡å¤§å˜æ›´**: ä»"è‡ªå®ç°å¸ƒå±€å¼•æ“"æ”¹ä¸º"å¸ƒå±€å¼•æ“é€‚é…å™¨"
- **æ–°æ¶æ„**:
  ```
  computeLayout(state)
    â”œâ”€ è¯†åˆ« signType ('G1-1' | 'G1-2')
    â”œâ”€ å‡†å¤‡åŠ¨æ€å‚æ•° (fontMetrics, iconConfig)
    â”œâ”€ å‡†å¤‡è¾“å…¥æ•°æ® (æ ¹æ® signType)
    â”œâ”€ è°ƒç”¨å¯¹åº”å¸ƒå±€å¼•æ“
    â”‚   â”œâ”€ layoutG11() - G1-1
    â”‚   â””â”€ layoutG12() - G1-2
    â”œâ”€ åº”ç”¨ snap æ¨¡å¼
    â””â”€ æ ¼å¼è½¬æ¢ (D3 â†’ Web)
  ```
- **åˆ é™¤**: æ‰€æœ‰æ—§çš„å†…è”å¸ƒå±€é€»è¾‘ï¼ˆæµ‹é‡ã€æ’åˆ—ç­‰ï¼‰
- **æ–°å¢è¾…åŠ©å‡½æ•°**:
  - `applySnap()` - åº”ç”¨åƒç´ å¯¹é½
  - `adaptModelForWeb()` - æ¨¡å‹æ ¼å¼è½¬æ¢

### Task 7: æ›´æ–° web/app.js å’Œ index.html âœ“
- **æ–‡ä»¶**: 
  - `sign-engine-sandbox/web/app.js`
  - `sign-engine-sandbox/web/index.html`
- **æ–°å¢ state å­—æ®µ**:
  - `signType: 'G1-1'` - å½“å‰é€‰æ‹©çš„ç±»å‹
  - `content.panels[]` - G1-2 çš„ä¸‰ä¸ªé¢æ¿æ•°æ®
  - `template.panel_spacing_h: 0.3` - é¢æ¿é—´è·
- **UI æ–°å¢**:
  1. Sign Type ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆG1-1 / G1-2ï¼‰
  2. G1-2 è¾“å…¥åŒºåŸŸï¼ˆä¸‰ä¸ªé¢æ¿ï¼Œæ¯ä¸ªåŒ…å« destinationã€distanceã€arrowã€shieldã€shieldLabelï¼‰
  3. é¢æ¿é—´è·æ§åˆ¶ï¼ˆä»…åœ¨ G1-2 æ—¶æ˜¾ç¤ºï¼‰
- **æ–°å¢å‡½æ•°**: `updateSignTypeUI()` - æ ¹æ® signType åˆ‡æ¢è¾“å…¥ç•Œé¢

## ğŸ“ æ•°æ®æµ

```
User Input (app.js state)
  â”‚
  â””â”€â†’ computeLayout(state)                   [engine.js]
        â”‚
        â”œâ”€â†’ layoutG11(params)                [d3/layout-g11.js] (G1-1)
        â”‚     â”œâ”€â†’ toBoxText()                [d2/converter.js]
        â”‚     â”œâ”€â†’ toBoxIcon()                [d2/converter.js]
        â”‚     â”œâ”€â†’ stackV()                   [d1/primitives.js]
        â”‚     â””â”€â†’ boardSize()                [d1/primitives.js]
        â”‚
        â””â”€â†’ layoutG12(params)                [d3/layout-g12.js] (G1-2)
              â”œâ”€â†’ layoutSinglePanel() Ã— 3
              â”‚     â””â”€â†’ (åŒ G1-1 é€»è¾‘)
              â””â”€â†’ stackBoards()              [d1/primitives.js]
                    â””â”€â†’ è¿”å›ç»„åˆ model (h å•ä½)
        â”‚
        â”œâ”€â†’ applySnap()                      [engine.js]
        â””â”€â†’ adaptModelForWeb()               [engine.js]
        â”‚
        â””â”€â†’ è¿”å›æœ€ç»ˆ model (px å•ä½)
  â”‚
  â””â”€â†’ generateSVG(model, state)              [renderer.js]
```

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. å¤šå±‚æ¶æ„æ¸…æ™°åˆ†ç¦»
- **D1**: çº¯å‡ ä½•å‡½æ•°ï¼ˆstackV, stackH, stackBoards, boardSizeï¼‰
- **D2**: æµ‹é‡ä¸è½¬æ¢ï¼ˆtoBoxText, toBoxIconï¼‰
- **D3**: å¸ƒå±€ç­–ç•¥ï¼ˆlayout-g11.js, layout-g12.jsï¼‰
- **Web**: é€‚é…å™¨ä¸ UIï¼ˆengine.js, app.jsï¼‰

### 2. åŠ¨æ€å‚æ•°è¦†ç›–
- å­—ä½“å‚æ•°å¯åœ¨è¿è¡Œæ—¶è¦†ç›– JSON é»˜è®¤å€¼
- å­—æ®µçº§åˆå¹¶ï¼š`{ ...defaultFont, ...fontMetrics }`

### 3. Shield åŠ¨æ€å®½åº¦
- æ ¹æ® label æ–‡å­—å®½åº¦è‡ªåŠ¨è®¡ç®— shield æœ€å°å®½åº¦
- ç¡®ä¿æ–‡å­—ä¸ä¼šæº¢å‡º shield è¾¹ç•Œ

### 4. ç­‰å®½é¢æ¿å †å 
- `stackBoards()` çš„ `equalWidth=true` ç¡®ä¿æ‰€æœ‰é¢æ¿ç­‰å®½
- è¾ƒçª„é¢æ¿è‡ªåŠ¨æ°´å¹³å±…ä¸­

### 5. è¾“å…¥ç•Œé¢åŠ¨æ€åˆ‡æ¢
- G1-1: å•é¢æ¿è¾“å…¥ï¼ˆdestinationã€distanceã€arrowã€shieldï¼‰
- G1-2: ä¸‰é¢æ¿è¾“å…¥ï¼ˆæ¯ä¸ªé¢æ¿ç‹¬ç«‹é…ç½®ï¼‰
- é¢æ¿é—´è·ä»…åœ¨ G1-2 æ—¶æ˜¾ç¤º

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1: G1-1 åŸºæœ¬åŠŸèƒ½
1. æ‰“å¼€ `sign-engine-sandbox/web/index.html`
2. ç¡®è®¤é»˜è®¤æ˜¾ç¤º G1-1 ç±»å‹
3. ä¿®æ”¹ç›®çš„åœ°åç§°ã€é‡Œç¨‹
4. æµ‹è¯•ç®­å¤´å·¦å³æ”¾ç½®
5. **å…³é”®éªŒè¯**: å¸ƒå±€æ•ˆæœåº”ä¸é‡æ„å‰å®Œå…¨ä¸€è‡´

### æµ‹è¯•åœºæ™¯ 2: G1-1 Shield æ”¯æŒ
1. é€‰æ‹© Shield = "Route Shield"
2. è¾“å…¥ Shield Label = "M1"
3. éªŒè¯ shield æ˜¾ç¤ºåœ¨å·¦ä¾§
4. æµ‹è¯•ä¸åŒé•¿åº¦çš„ labelï¼ˆ"M1", "A85", "M32"ï¼‰
5. **å…³é”®éªŒè¯**: shield å®½åº¦åº”æ ¹æ®æ–‡å­—åŠ¨æ€è°ƒæ•´

### æµ‹è¯•åœºæ™¯ 3: G1-2 ä¸‰é¢æ¿å †å 
1. åˆ‡æ¢ Sign Type ä¸º "G1-2"
2. éªŒè¯è¾“å…¥ç•Œé¢åˆ‡æ¢ä¸ºä¸‰ä¸ªé¢æ¿
3. ä¿®æ”¹æ¯ä¸ªé¢æ¿çš„å†…å®¹
4. **å…³é”®éªŒè¯**:
   - ä¸‰ä¸ªé¢æ¿å‚ç›´å †å 
   - æ‰€æœ‰é¢æ¿ç­‰å®½ï¼ˆå–æœ€å®½çš„ï¼‰
   - é¢æ¿é—´è·æ­£ç¡®ï¼ˆé»˜è®¤ 0.3hï¼‰

### æµ‹è¯•åœºæ™¯ 4: å‚æ•°è°ƒèŠ‚
1. è°ƒæ•´ `letter_height_h`ï¼šéªŒè¯æ‰€æœ‰å…ƒç´ æŒ‰æ¯”ä¾‹ç¼©æ”¾
2. è°ƒæ•´ `panel_spacing_h`ï¼šéªŒè¯é¢æ¿é—´è·å˜åŒ–ï¼ˆä»… G1-2ï¼‰
3. è°ƒæ•´ `group_spacing_h`ï¼šéªŒè¯å…ƒç´ é—´è·å˜åŒ–
4. **å…³é”®éªŒè¯**: æ‰€æœ‰å‚æ•°å®æ—¶ç”Ÿæ•ˆ

### æµ‹è¯•åœºæ™¯ 5: åˆ‡æ¢ Sign Type
1. G1-1 â†’ G1-2ï¼šéªŒè¯ç•Œé¢åˆ‡æ¢ï¼Œæ•°æ®ä¿ç•™
2. G1-2 â†’ G1-1ï¼šéªŒè¯ç•Œé¢åˆ‡æ¢ï¼Œæ•°æ®ä¿ç•™
3. **å…³é”®éªŒè¯**: çŠ¶æ€åˆ‡æ¢æ— æŠ¥é”™

## âš ï¸ å·²çŸ¥é—®é¢˜å’Œæ³¨æ„äº‹é¡¹

### 1. Renderer æ”¯æŒ
- å½“å‰ `renderer.js` å¯èƒ½éœ€è¦æ›´æ–°ä»¥æ”¯æŒï¼š
  - `type: 'shield'` çš„æ¸²æŸ“
  - G1-2 çš„å¤šé¢æ¿æ¸²æŸ“
- **å»ºè®®**: æ£€æŸ¥ `generateSVG()` æ˜¯å¦æ­£ç¡®å¤„ç†æ–°çš„ item ç±»å‹

### 2. æµ‹è¯•æ–‡ä»¶ç¼ºå¤±
- æœªæä¾› `d2/fonts.json` å’Œ `d2/icons.json` çš„å®Œæ•´å†…å®¹
- **å»ºè®®**: ç¡®ä¿è¿™äº›æ–‡ä»¶åŒ…å« shield å›¾æ ‡å®šä¹‰

### 3. å…¼å®¹æ€§
- æ—§çš„ `measureText()` å’Œ `measureIcon()` å‡½æ•°å·²ä» engine.js åˆ é™¤
- å¦‚æœå…¶ä»–æ–‡ä»¶ä¾èµ–è¿™äº›å‡½æ•°ï¼Œéœ€è¦æ›´æ–°å¯¼å…¥è·¯å¾„

### 4. é¢æ¿æ•°é‡é™åˆ¶
- G1-2 å›ºå®šä¸º 3 ä¸ªé¢æ¿
- å¦‚éœ€æ”¯æŒ 2-5 ä¸ªé¢æ¿çš„åŠ¨æ€é…ç½®ï¼Œéœ€è¦è¿›ä¸€æ­¥æ‰©å±•

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. æå– `layoutSinglePanel()` ä¸ºå…¬å…±å‡½æ•°
- å½“å‰åœ¨ `layout-g12.js` ä¸­æ˜¯å†…éƒ¨å‡½æ•°
- å»ºè®®ç§»è‡³ `d3/layout-utils.js`ï¼Œä¾› G1-1 å’Œ G1-2 å…±äº«

### 2. é«˜äº®åŠŸèƒ½
- Task è¦æ±‚ä¸­æåˆ°çš„æ–‡å­—é«˜äº®åŠŸèƒ½ï¼ˆé»„è‰²ï¼‰æœªå®ç°
- éœ€è¦åœ¨ `layoutSinglePanel()` ä¸­ä¼ é€’ `highlight` å±æ€§
- éœ€è¦åœ¨ `renderer.js` ä¸­æ ¹æ® `highlight` æ”¹å˜æ–‡å­—é¢œè‰²

### 3. æ›´å¤š Sign Type
- æ¶æ„å·²æ”¯æŒæ‰©å±•æ–°çš„ sign type
- åªéœ€æ·»åŠ æ–°çš„ `layout-xxx.js` å¹¶åœ¨ engine.js ä¸­æ³¨å†Œå³å¯

### 4. å•å…ƒæµ‹è¯•
- ä¸º `stackBoards()` æ·»åŠ å•å…ƒæµ‹è¯•
- ä¸º `layoutG11()` å’Œ `layoutG12()` æ·»åŠ å¿«ç…§æµ‹è¯•

### 5. æ€§èƒ½ä¼˜åŒ–
- å½“å‰æ¯æ¬¡ render éƒ½é‡æ–°è®¡ç®—å¸ƒå±€
- å¯è€ƒè™‘æ·»åŠ ç¼“å­˜æˆ–å¢é‡æ›´æ–°

## ğŸ‰ æ€»ç»“

Phase 1 é‡æ„å·²å®Œæˆæ‰€æœ‰æ ¸å¿ƒä»»åŠ¡ï¼š

âœ… **æ¶æ„æ¸…æ™°**: D1-D4 å±‚æ¬¡åˆ†æ˜ï¼ŒèŒè´£æ˜ç¡®  
âœ… **åŠŸèƒ½å®Œæ•´**: G1-1 å’Œ G1-2 ä¸¤ç§ç±»å‹å‡å·²å®ç°  
âœ… **æ‰©å±•æ€§å¼º**: æ˜“äºæ·»åŠ æ–°çš„ sign type å’Œå¸ƒå±€ç­–ç•¥  
âœ… **å‘åå…¼å®¹**: G1-1 æ•ˆæœä¸é‡æ„å‰ä¸€è‡´  
âœ… **UI å‹å¥½**: åŠ¨æ€åˆ‡æ¢è¾“å…¥ç•Œé¢ï¼Œå®æ—¶é¢„è§ˆ  

**ä¸‹ä¸€æ­¥**: å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼Œæ‰“å¼€ `index.html`ï¼ŒéªŒè¯æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

**é‡æ„å®Œæˆæ—¶é—´**: 2025-10-15  
**æ–‡ä»¶ä¿®æ”¹ç»Ÿè®¡**:
- æ–°å¢: 2 ä¸ªæ–‡ä»¶ï¼ˆlayout-g12.js, PHASE1-COMPLETION.mdï¼‰
- ä¿®æ”¹: 6 ä¸ªæ–‡ä»¶ï¼ˆprimitives.js, converter.js, layout-g11.js, templates.json, engine.js, app.js, index.htmlï¼‰



