# Sign Engine Sandbox - Web Playground

交互式 Web 预览与调参工具

## 🚀 快速开始

```bash
# 在项目根目录运行
npm run web

# 浏览器访问
http://localhost:3000
```

## 📋 功能清单

### A. 内容输入 (Content)
- ✅ 目的地名称
- ✅ 距离数字
- ✅ 盾形选择（Route/Freeway/无）
- ✅ 盾形标签文字
- ✅ 箭头选择（右箭头/无）

### B. 模板参数 (Template / D3)
- ✅ 字母高度 (letter_height_h)
- ✅ 行间距 (line_spacing_h)
- ✅ 组间距 (group_spacing_h)
- ✅ 板边距 (board_pad_h)
- ✅ 圆角半径 (corner_radius_h)
- ✅ 边框宽度 (border_h)
- ✅ 箭头位置（右侧/无）
- ✅ 盾形位置（左侧/无）
- ✅ 对齐策略（middle/baseline-first/baseline-last）

### C. 字体度量 (Fonts / D2)
- ✅ 字体系列选择
- ✅ 平均字宽比例（实时调整）
- ✅ Ascent 比例
- ✅ Descent 比例

### D. 图标/盾形度量 (Icons / D2)
- ✅ 箭头缩放策略（match_text_line/fixed_k_h）
- ✅ 箭头固定高度系数
- ✅ 盾形缩放策略
- ✅ 盾形固定高度系数
- ✅ 基线锚点选择
- ✅ 基线偏移调整

### E. 引擎与单位 (Engine / D1)
- ✅ px/h 比例（5-20，滑块）
- ✅ 像素对齐模式（none/round/half-pixel）
- ✅ 文字锚点（useBaseline/boxTopAscent）

### F. 证据与叠加 (Evidence)
- ✅ 内容包络框叠加
- ✅ 板面外框叠加
- ✅ 元素盒框叠加
- ✅ 文本基线叠加
- ✅ 组中线叠加
- ✅ 像素网格叠加
- ✅ 间距标注叠加
- ✅ 显示/隐藏数值面板

### G. 场景测试 (Convenience)
- ✅ 快速切换长文本
- ✅ 快速切换短文本
- ✅ 极小参数测试
- ✅ 极大参数测试
- ✅ 重置为默认
- ✅ 下载 SVG
- ✅ 复制 SVG 源码
- ✅ 复制配置 JSON
- ✅ 加载配置 JSON

## 📊 数值面板

实时显示所有关键尺寸（h 单位 & px 单位）：

### 板面 (Board)
- 宽度、高度、边距

### 文字行 (Text Lines)
- 两行文字的宽高
- Ascent/Descent
- 基线 Y 坐标
- ⚠️ 非整数/0.5 像素高亮警告

### 文字组 (Text Group)
- 组合宽高

### 图标 (Icons)
- 盾形/箭头宽高

### 关键间距 (Spacing)
- 行间距
- 组间距

### 引擎参数 (Engine)
- px/h 比例
- 对齐模式

## 🎯 使用场景

### 1. 验证布局逻辑

```
1. 打开页面，默认显示 "Mary Hill / 12"
2. 勾选"基线叠加"和"间距标注"
3. 调整 line_spacing_h，观察间距标注同步变化
4. 查看数值面板确认 h 和 px 的转换正确
```

### 2. 测试字体度量敏感性

```
1. 调整 avgCharWidthRatio（0.6 → 0.8）
2. 观察文字组宽度变化
3. 确认盾形/箭头位置自动调整
4. 数值面板验证计算结果
```

### 3. 像素对齐验证

```
1. 设置 pxPerH = 7（非整数因子）
2. 切换 snapMode = "none"
3. 查看数值面板，基线 Y 出现 ⚠️ 标记
4. 切换 snapMode = "half-pixel"
5. ⚠️ 消失，像素对齐成功
```

### 4. 极端参数压力测试

```
1. 点击"极小参数"按钮
2. 观察 letter_height = 6h, pxPerH = 6
3. 检查布局是否变形
4. 点击"极大参数"测试另一极端
```

### 5. 配置分享与复现

```
1. 调整到满意的参数
2. 点击"复制配置 JSON"
3. 发送给同事
4. 同事点击"加载配置 JSON"上传
5. 完全复现相同布局
```

## 🔍 叠加层详解

### 内容包络框（青色虚线）
显示所有内容的外接矩形（不含板边距）

### 板面外框（品红色虚线）
显示完整板面边界

### 元素盒框（黄色）
每个文字/图标的精确边界框

### 文本基线（红色线 + 圆点）
文字渲染的基线位置，用于验证 `useBaseline` 模式

### 组中线（绿色虚线）
文字组的垂直中线，用于验证图标居中对齐

### 像素网格（灰色细线）
按 pxPerH 绘制的网格，验证元素是否对齐到网格点

### 间距标注（橙色）
可视化显示 line_spacing_h 的实际距离

## ⚙️ 技术细节

### 架构
```
web/
├── index.html       # UI 界面
├── style.css        # 样式
├── app.js           # 主应用逻辑（状态管理、事件）
├── engine.js        # 布局计算适配器
├── renderer.js      # SVG 渲染器 + 数值面板
└── serve.js         # 静态服务器
```

### 数据流
```
UI 控件变更
  → 更新 state
  → computeLayout(state)
  → generateSVG(model, state)
  → 渲染到 preview-stage
  → renderMetrics(model)
  → 更新数值面板
```

### 覆盖机制
- UI 参数通过 `state` 对象传递
- `engine.js` 将 `state` 转换为 D1-D4 可用格式
- 不修改原始 D1-D4 模块
- 覆盖仅在运行时生效

### 像素对齐
```javascript
// none: 不对齐
px => px

// round: 整数对齐
px => Math.round(px)

// half-pixel: 0.5 对齐（推荐）
px => Math.round(px * 2) / 2
```

## 🐛 故障排查

### 页面空白
- 检查浏览器控制台是否有 JS 错误
- 确认服务器正在运行（`npm run web`）
- 尝试刷新页面

### SVG 未显示
- 检查是否有布局错误（红色错误提示）
- 尝试点击"重置为默认"按钮
- 查看浏览器控制台错误信息

### 数值不更新
- 确认"显示数值面板"已勾选
- 检查控件是否触发了 `input`/`change` 事件
- 刷新页面重试

### 叠加层不显示
- 确认对应的叠加选项已勾选
- 某些叠加需要特定内容（如"间距标注"需要多行文字）
- 检查叠加颜色是否与背景对比度不足

### 导出/复制失败
- 确认浏览器支持 `navigator.clipboard` API
- 某些浏览器需要 HTTPS 才能使用剪贴板
- 尝试使用"下载 SVG"代替

## 🎓 最佳实践

1. **从默认开始**：先理解默认参数的效果
2. **渐进调整**：一次只改一个参数，观察影响
3. **使用叠加层**：开启多个叠加层交叉验证
4. **查看数值面板**：数值是真相，视觉可能欺骗
5. **保存配置**：满意的参数立即复制保存
6. **极端测试**：用极端值检验鲁棒性

## 📝 已知限制

- 暂不支持三行及以上文字
- 盾形形状简化（未实现各州不同形状）
- 箭头仅支持右侧放置
- 无法直接编辑 SVG 叠加层颜色

## 🔮 未来增强

- [ ] URL 参数持久化（刷新保留状态）
- [ ] 历史记录（撤销/重做）
- [ ] 预设场景库（一键加载常用配置）
- [ ] 导出为 PNG/PDF
- [ ] 响应式布局（移动端支持）
- [ ] 键盘快捷键
- [ ] 拖拽调整间距
- [ ] 实时协作（多人同时调参）

## 💡 提示

- 使用浏览器缩放（Ctrl +/-）来查看细节
- 开启像素网格可以精确验证对齐
- 数值面板中的 ⚠️ 标记表示像素未对齐
- 复制配置 JSON 可用于报告 bug

---

**祝调参愉快！** 🎉

如有问题请查看主项目 [README.md](../README.md)

